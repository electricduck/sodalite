#!/usr/bin/env bash

migrate_pidfile="/var/run/sodalite-hacks/migrate.pid"
migrate_status_file="/var/run/sodalite-hacks/migrate-status"
zenity_width="300"

function check_migration_status() {
    while true
    do
        if [[ -f "$migrate_pidfile" ]]; then
            if [[ "$(cat "$migrate_status_file")" != "" ]]; then
                {
                    while true
                    do
                        if [[ -f $migrate_pidfile ]]; then
                            echo "# $(cat $migrate_status_file)"; sleep 1
                        else
                            break
                        fi
                    done
                } | zenity --progress \
                    --title="Migrating" \
                    --text="Doing things..." \
                    --width 300 \
                    --pulsate \
                    --no-cancel \
                    --auto-close \
                    --auto-kill

                break
            else
                sleep 1
            fi
        else
            break
        fi
    done
}

function set_locale() {
    system_locale=$(localectl status | grep "System Locale:" | cut -d ':' -f2 | cut -d '=' -f2)
    gtk_locale=$(gsettings get org.gnome.system.locale region)

    if [[ "$gtk_locale" == "'$system_locale'" ]]; then
        gsettings set org.gnome.system.locale region $system_locale
        zenity --info \
            --icon-name "info" \
            --title "Sodalite" \
            --text "Locale set to '$system_locale'. Re-login to see changes." \
            --width $zenity_width
    fi

}

check_migration_status
set_locale
