#!/usr/bin/env bash

migrate_pidfile="/var/run/sodalite-hacks/migrate.pid"
migrate_status_file="/var/run/sodalite-hacks/migrate-status"
pidfile="/var/run/user/$UID/sodalite-user-daemon.pid"
zenity_width="300"

function touchp() {
    mkdir -p "$(dirname "$1")/" && touch "$1"
}

function check_migration_status() {
    waiting=0

    while true
    do
        if [[ -f "$migrate_pidfile" ]] && [[ "$(cat "$migrate_status_file")" != "" ]]; then
            {
                while true
                do
                    if [[ -f $migrate_pidfile ]]; then
                        echo "# $(cat $migrate_status_file)"; sleep 1
                    else
                        break
                    fi
                done
            } | zenity --progress \
                --title="Migrating" \
                --text="Doing things..." \
                --width 300 \
                --pulsate \
                --no-cancel \
                --auto-close \
                --auto-kill
        else
            sleep 1
        fi
    done
}

function install_skel() {
    skel="/etc/skel"
    files=(
        ".bashrc"
        ".config/touchegg/touchegg.conf"
    )

    for file in "${files[@]}"; do
        if [[ ! -f "$HOME/$file" ]]; then
            touchp "$HOME/$file"
            cp -f "$skel/$file" "$HOME/$file"
        fi
    done
}

function set_locale() {
    # TODO: Change in AccountsService

    system_locale=$(localectl status | grep "System Locale:" | cut -d ':' -f2 | cut -d '=' -f2)
    gtk_locale=$(gsettings get org.gnome.system.locale region)

    if [[ "$gtk_locale" != "'$system_locale'" ]]; then
        gsettings set org.gnome.system.locale region $system_locale
        zenity --info \
            --icon-name "info" \
            --title "Sodalite" \
            --text "Locale set to '$system_locale'. Re-login to see changes." \
            --width $zenity_width
    fi

}

if [[ -f $pidfile ]]; then
    exit
else
    touch "$pidfile"
    echo "$$" > "$pidfile"
fi

install_skel
#set_locale

check_migration_status &

wait
rm $pidfile
